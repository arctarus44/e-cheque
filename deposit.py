import tools
import sys
import os
from configparser import ConfigParser
from configparser import ParsingError
from rsa import RSA
from re import split

ALREADY_PAY_IN = "This cheque is already pay in."
PAY_IN = "This cheque is cashed now."
CUSTOMER_NOT_FOUND = "The customer {0} is not found is the database."
SELLER_SIGN_ERROR = "An error occured during the decoding of the seller sign. The signature might be incorrect"


def decode_sign(sign, pub_k):
	"""Decode the signature with pub_k as an instance of RSA
	and retourne the result as a ConfigParser instance corresponding to the
	decoded content."""

	decoded = pub_k.check_signature(sign)

	tmp = open(tools.TMP_FILE, 'w')
	tmp.write(decoded)
	tmp.close()

	decoded_cp = ConfigParser()
	decoded_cp.read(tools.TMP_FILE)
	os.remove(tools.TMP_FILE)
	return decoded_cp

def cashed_cheque(cheque):
	"""Cashed the cheque"""
	drawee = cheque[tools.SCT_C_CHEQUE][tools.OPT_C_DRAWER]
	total = cheque[tools.SCT_C_CHEQUE][tools.OPT_C_TOTAL]
	transac_id = cheque[tools.SCT_C_CHEQUE][tools.OPT_C_TRANS_ID]

	db_fname = os.path.join(tools.DIR_BANK, tools.FILE_BANK_DB)
	database = ConfigParser()
	database.read(db_fname)
	database.set(drawee, transac_id, total)

	with open(db_fname, 'w') as db_f:
		database.write(db_f)


def check_pay_in(cheque):
	"""Cheque if the cheque is already pay in. Return True if the cheque
	is already pay in. False otherwise."""
	database = ConfigParser()
	database.read(os.path.join(tools.DIR_BANK, tools.FILE_BANK_DB))

	drawee = cheque[tools.SCT_C_CHEQUE][tools.OPT_C_DRAWER]
	transac_id = cheque[tools.SCT_C_CHEQUE][tools.OPT_C_TRANS_ID]

	if database.has_option(drawee, transac_id):
		return True
	else:
		return False


if __name__ == "__main__":

	bank_prk_fname = os.path.join(tools.DIR_BANK, tools.FILE_PUB_KEY)

	seller_puk_sing_fname = os.path.join(tools.DIR_BANK,
										 tools.DIR_SELLER,
										 tools.FILE_PUB_SIGN)

	seller_puk = tools.decode_public_key(seller_puk_sing_fname,
										 bank_prk_fname,
										 tools.ROLE_BANK)

	seller_puk = RSA(int(seller_puk[tools.SCT_K_KEY][tools.OPT_K_N]),
					 e=int(seller_puk[tools.SCT_K_KEY][tools.OPT_K_E]))

	# Read the seller's signature from stdin and retreive the cheque's
	# signature generated by the drawee
	try:
		seller_sign = tools.read_stdin()
	except ParsingError:
		print(SELLER_SIGN_ERROR)
		exit(1)

	drawee_sign = decode_sign(seller_sign[tools.ROLE_SELLER][tools.OPT_S_SIGN],
							  seller_puk)

	# Decode the cheque
	drawee = drawee_sign.sections()[0]
	drawee_puk_sing_fname = os.path.join(tools.DIR_CUSTOMERS,
										 drawee,
										 tools.FILE_PUB_SIGN)

	drawee_puk = tools.decode_public_key(drawee_puk_sing_fname,
										 bank_prk_fname,
										 tools.ROLE_BANK)

	drawee_puk = RSA(int(drawee_puk[tools.SCT_K_KEY][tools.OPT_K_N]),
					 e=int(drawee_puk[tools.SCT_K_KEY][tools.OPT_K_E]))

	cheque = decode_sign(drawee_sign[drawee][tools.OPT_S_SIGN],
						 drawee_puk)

	tools.check_config(cheque, tools.STRCT_CHEQUE)

	if check_pay_in(cheque): # the check are already pay in
		print(ALREADY_PAY_IN)
		exit(1)
	else:
		try:
			cashed_cheque(cheque)
		except KeyError:
			print(CUSTOMER_NOT_FOUND.format(drawee), file=sys.stderr)
		print(PAY_IN)
